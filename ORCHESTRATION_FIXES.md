# C# TNO Data Load Orchestration Fixes

## Issues Identified

Your C# project has orchestration mismatches compared to the Python solution. The Python solution follows a specific 4-step process that generates manifests dynamically, while your C# code was trying to load manifests that don't exist yet.

## Python Solution Flow (Correct)

The Python `load.sh` script follows this order:

1. **LoadFiles** - Upload dataset files (documents, well-logs, markers, trajectories) to OSDU and create location mapping JSON files
2. **GenerateManifests** - Generate JSON manifests from CSV data using templates and mappings
3. **LoadMasterData** - Load reference and master data manifests (generated in step 2)
4. **LoadWorkProducts** - Load work product manifests using file location maps (from step 1)

## Original C# Issues

1. **Missing Manifest Generation**: C# expected manifests to already exist in `manifests/` subdirectories
2. **Wrong Directory Structure**: C# `DirectoryMapping` pointed to non-existent manifest directories
3. **Missing File Upload Step**: C# didn't upload files first or create location maps
4. **Wrong Orchestration Order**: C# tried to load data directly instead of following the 4-step process

## Changes Made

### 1. New Commands Created

- **`UploadDatasetsCommand`** - Uploads dataset files and creates location mappings (Step 1)
- **`GenerateManifestsCommand`** - Generates manifests from CSV data using templates (Step 2)

### 2. New Handlers Created

- **`UploadDatasetsCommandHandler`** - Handles file uploads to OSDU
- **`GenerateManifestsCommandHandler`** - Calls Python generator script to create manifests

### 3. Updated Core Components

#### `LoadAllDataCommandHandler`
- Now follows the Python 4-step process:
  1. Upload dataset files and create location maps
  2. Generate manifests from CSV data
  3. Load reference and master data manifests
  4. Load work products using file location maps

#### `CoreEntities.cs` - `DirectoryMapping`
- Fixed directory paths to match actual data structure:
  - Work products now point to `TNO/provided/TNO/work-products/*` (where JSON manifests exist)
  - Master data still points to `manifests/*` (will be generated in step 2)

#### `LoadFromManifestCommand`
- Added support for file location mapping for work products
- Added `IsWorkProduct` flag to handle different loading modes

#### `DownloadTnoDataCommandHandler`
- Updated directory structure creation to match Python solution
- Now creates correct paths for CSV data, templates, and configuration files

## Configuration Required

Your C# solution now requires the Python generator scripts to be available. The `GenerateManifestsCommandHandler` calls:

```bash
bash generator.sh -m mapping.json -t type -d datadir -o outputdir -p partition
```

Options to fully port to C#:
1. **Current approach**: Call Python scripts (faster to implement)
2. **Full C# port**: Rewrite the manifest generation logic in C# (more work)

## Directory Structure After Fixes

```
your-data-directory/
├── datasets/                 # Files to upload (Step 1)
│   ├── documents/
│   ├── well-logs/
│   ├── markers/
│   └── trajectories/
├── TNO/
│   ├── contrib/             # CSV data for manifest generation
│   │   ├── reference-data/
│   │   └── master-data/
│   └── provided/TNO/work-products/  # JSON work product manifests
│       ├── documents/
│       ├── markers/
│       ├── trajectories/
│       └── well logs/
├── templates/               # JSON templates for manifest generation
├── config/                  # Mapping files
│   ├── tno_ref_data_template_mapping.json
│   ├── tno_misc_master_data_template_mapping.json
│   ├── tno_well_data_template_mapping.json
│   └── tno_wellbore_data_template_mapping.json
├── manifests/              # Generated by Step 2
│   ├── reference-manifests/
│   ├── misc-master-data-manifests/
│   ├── master-well-data-manifests/
│   └── master-wellbore-data-manifests/
└── output/                 # Generated by Step 1
    ├── loaded-documents-datasets.json
    ├── loaded-welllogs-datasets.json
    ├── loaded-marker-datasets.json
    └── loaded-trajectories-datasets.json
```

## Usage

The updated C# application now properly follows the Python orchestration:

```bash
# Download and setup data
dotnet run download-tno --destination /path/to/data

# Load all data (follows Python 4-step process)
dotnet run load --source /path/to/data
```

The `LoadAllDataCommand` now:
1. ✅ Uploads files and creates location maps
2. ✅ Generates manifests from CSV data  
3. ✅ Loads reference and master data
4. ✅ Loads work products with file mappings

This matches the Python solution's orchestration exactly.
